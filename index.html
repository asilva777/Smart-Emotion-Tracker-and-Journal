<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Emotional Wellness Tracker</title>
  <link rel="manifest" href="manifest.json">
  <style>
  <link rel="stylesheet" href="style.css"> 
</head>
<body>
  <button class="dark-toggle btn-secondary" aria-pressed="false" aria-label="Toggle dark mode" id="darkToggle">🌙</button>
  <main class="container" role="main">
    <h1>Emotional Wellness Tracker</h1>
    <!-- 1. What’s going on now? -->
    <section class="section" aria-labelledby="activity-title">
      <h3 id="activity-title">1. What's going on now?</h3>
      <div class="tags" id="activity-tags" role="listbox" aria-label="Activity tags"></div>
      <form class="add-tag" onsubmit="return false;">
        <input type="text" id="newTagName" maxlength="20" placeholder="Add tag (e.g. Study)">
        <button type="button" onclick="addActivityTag()">Add Tag</button>
      </form>
    </section>

    <!-- 2. How’s your mood? -->
    <section class="section" aria-labelledby="mood-title">
      <h3 id="mood-title">2. How's your mood?</h3>
      <div id="emotion-wheel-container">
        <svg id="emotion-wheel" width="320" height="320" viewBox="0 0 320 320" aria-label="Emotion Wheel"></svg>
        <div id="selected-emotion" aria-live="polite"></div>
        <em style="font-size: 0.95em; color:#333;">Tap a segment to select your primary emotion</em>
      </div>
      <div class="faces" id="mood-faces" aria-label="Mood faces">
        <span class="face" tabindex="0" title="Very sad" role="button" aria-label="Very sad">&#128577;</span>
        <span class="face" tabindex="0" title="Sad" role="button" aria-label="Sad">&#128542;</span>
        <span class="face" tabindex="0" title="Neutral" role="button" aria-label="Neutral">&#128528;</span>
        <span class="face" tabindex="0" title="Happy" role="button" aria-label="Happy">&#128522;</span>
        <span class="face" tabindex="0" title="Very happy" role="button" aria-label="Very happy">&#128515;</span>
      </div>
      <form class="add-emotion" onsubmit="return false;">
        <input type="text" id="newEmotionName" maxlength="20" placeholder="New emotion (e.g. Grateful)" aria-label="New emotion">
        <input type="color" id="newEmotionColor" value="#888888" aria-label="Pick color">
        <button type="button" onclick="addEmotion()">Add Emotion</button>
      </form>
      <button id="saveEmotion" disabled>Save Emotion</button>
      <canvas id="emotionBarChart" loading="lazy"></canvas>
    </section>

    <!-- 3. How are you physically? -->
    <section class="section" aria-labelledby="phys-title">
      <h3 id="phys-title">3. How are you physically?</h3>
      <div class="hearts" id="physical-hearts" aria-label="Physical condition hearts">
        <span class="heart" tabindex="0" title="Poor" role="button" aria-label="Poor">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Fair" role="button" aria-label="Fair">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Average" role="button" aria-label="Average">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Good" role="button" aria-label="Good">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Excellent" role="button" aria-label="Excellent">&#10084;&#65039;</span>
      </div>
    </section>

    <!-- 4. Track blood pressure, weight, and thoughts -->
    <section class="section track-options" aria-labelledby="track-title">
      <h3 id="track-title" class="visually-hidden">Track Options</h3>
      <form id="track-form" autocomplete="off" novalidate>
        <div class="input-group">
          <label for="bp">Blood Pressure:</label>
          <input id="bp" type="text" pattern="^\d{2,3}\/\d{2,3}$" placeholder="e.g., 120/80" aria-describedby="bpHelp">
          <small id="bpHelp" style="display:block; color:#666;">Format: systolic/diastolic (e.g., 120/80)</small>
        </div>
        <div class="input-group">
          <label for="weight">Weight (kg):</label>
          <input id="weight" type="number" step="0.1" min="10" max="300" placeholder="e.g., 70.5">
        </div>
        <div class="input-group">
          <label for="thoughts">Thoughts or Reflections:</label>
          <textarea id="thoughts" placeholder="Add any thoughts or notes..."></textarea>
        </div>
        <button class="btn" id="log-entry" type="submit">Log Entry</button>
        <div id="formError" class="error-msg" role="alert"></div>
      </form>
    </section>

    <!-- 5. User statistics display -->
    <section class="stats" id="user-stats" aria-labelledby="stats-title">
      <h4 id="stats-title">Your Statistics</h4>
      <div class="stat-item">Average Mood: <span id="stat-mood">🙂</span></div>
      <div class="stat-item">Physical Condition: <span id="stat-physical">Good</span></div>
      <div class="stat-item">Blood Pressure: <span id="stat-bp">120/80</span></div>
      <div class="stat-item">Weight: <span id="stat-weight">70.5 kg</span></div>
    </section>

    <section aria-labelledby="entries-title">
      <h2 id="entries-title">My Entries</h2>
      <ul id="emotionList" aria-live="polite"></ul>
    </section>
    <section class="export-import" aria-label="Export and Import Data">
      <button class="btn-secondary" onclick="exportData()">Export Data</button>
      <input type="file" id="importDataFile" accept=".json" style="display:none" onchange="importDataFile(this)">
      <button class="btn-secondary" onclick="document.getElementById('importDataFile').click();">Import Data</button>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- For production, move JS to external file -->
  <script>
    // --- Dark mode toggle ---
    const darkToggle = document.getElementById('darkToggle');
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      darkToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
      localStorage.setItem('ewt_dark', isDark ? '1' : '');
    });
    if (localStorage.getItem('ewt_dark')) document.body.classList.add('dark-mode');

    // --- Activity tags management ---
    const defaultTags = ["Sleep", "Workout", "Meal", "Work", "Headache", "Stressed", "Relaxing", "Social", "Other"];
    function loadTags() {
      return JSON.parse(localStorage.getItem('activityTags')) || defaultTags;
    }
    function saveTags(tags) {
      localStorage.setItem('activityTags', JSON.stringify(tags));
    }
    function sanitize(str) {
      const el = document.createElement('div');
      el.innerText = str;
      return el.innerHTML.trim();
    }
    function renderTags() {
      const tagBox = document.getElementById('activity-tags');
      tagBox.innerHTML = '';
      loadTags().forEach(tag => {
        const div = document.createElement('div');
        div.className = 'tag';
        div.setAttribute('role', 'option');
        div.setAttribute('tabindex', '0');
        div.textContent = tag;
        div.onclick = () => div.classList.toggle('selected');
        div.onkeydown = e => { if (e.key === ' ' || e.key === 'Enter') div.classList.toggle('selected'); };
        tagBox.appendChild(div);
      });
    }
    function addActivityTag() {
      const inp = document.getElementById('newTagName');
      let tag = sanitize(inp.value.trim());
      if (!tag) return;
      let tags = loadTags();
      if (tags.map(t => t.toLowerCase()).includes(tag.toLowerCase())) { inp.value=''; return; }
      tags.push(tag);
      saveTags(tags);
      inp.value = '';
      renderTags();
    }

    // --- Emotions (custom + SVG wheel) ---
    const defaultEmotions = [
      { name: 'Happy', color: '#FFD700' },
      { name: 'Sad', color: '#1E90FF' },
      { name: 'Angry', color: '#FF6347' },
      { name: 'Calm', color: '#32CD32' },
      { name: 'Anxious', color: '#FFB347' },
      { name: 'Excited', color: '#E67E22' },
      { name: 'Tired', color: '#A9A9A9' },
      { name: 'Surprised', color: '#8e44ad' }
    ];
    const svgEmotions = [
      { name: "Joy", color: "#FFE066" },
      { name: "Trust", color: "#8BC34A" },
      { name: "Fear", color: "#00BCD4" },
      { name: "Surprise", color: "#448AFF" },
      { name: "Sadness", color: "#90A4AE" },
      { name: "Disgust", color: "#9C27B0" },
      { name: "Anger", color: "#FF7043" },
      { name: "Anticipation", color: "#FFEE58" }
    ];
    function loadEmotions() {
      return JSON.parse(localStorage.getItem('emotionsList')) || defaultEmotions;
    }
    function saveEmotions(emotions) {
      localStorage.setItem('emotionsList', JSON.stringify(emotions));
    }
    function addEmotion() {
      const nameInput = document.getElementById('newEmotionName');
      const colorInput = document.getElementById('newEmotionColor');
      const name = sanitize(nameInput.value.trim());
      const color = colorInput.value;
      if (!name) { alert('Enter an emotion name.'); return; }
      let emotions = loadEmotions();
      if (emotions.some(e => e.name.toLowerCase() === name.toLowerCase())) {
        alert('Emotion already exists.');
        return;
      }
      emotions.push({ name, color });
      saveEmotions(emotions);
      drawEmotionWheel();
      nameInput.value = '';
      colorInput.value = '#888888';
    }

    // --- Emotion Wheel ---
    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
      const angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;
      return {
        x: centerX + (radius * Math.cos(angleInRadians)),
        y: centerY + (radius * Math.sin(angleInRadians))
      };
    }
    function describeArc(x, y, radius, startAngle, endAngle){
      const start = polarToCartesian(x, y, radius, endAngle);
      const end = polarToCartesian(x, y, radius, startAngle);
      const arcSweep = endAngle - startAngle <= 180 ? "0" : "1";
      return [
        "M", x, y,
        "L", start.x, start.y, 
        "A", radius, radius, 0, arcSweep, 0, end.x, end.y,
        "Z"
      ].join(" ");
    }
    let selectedEmotion = null;
    function drawEmotionWheel() {
      const svg = document.getElementById('emotion-wheel');
      svg.innerHTML = '';
      const center = 160, radius = 135;
      const angleStep = 360 / svgEmotions.length;
      for (let i = 0; i < svgEmotions.length; i++) {
        const startAngle = i * angleStep;
        const endAngle = startAngle + angleStep;
        const emotion = svgEmotions[i];
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", describeArc(center, center, radius, startAngle, endAngle));
        path.setAttribute("fill", emotion.color);
        path.setAttribute("stroke", "#fff");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("data-emotion", emotion.name);
        path.setAttribute("tabindex", "0");
        path.setAttribute("role", "button");
        path.style.cursor = "pointer";
        path.addEventListener("click", onSectorClick);
        path.addEventListener("keydown", e => { if (e.key === " " || e.key === "Enter") onSectorClick({target:path}); });
        svg.appendChild(path);
        // Label
        const labelAngle = startAngle + angleStep/2;
        const labelPos = polarToCartesian(center, center, radius * 0.75, labelAngle);
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", labelPos.x);
        text.setAttribute("y", labelPos.y);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.setAttribute("font-size", "15");
        text.setAttribute("fill", "#222");
        text.textContent = emotion.name;
        svg.appendChild(text);
      }
    }
    function onSectorClick(evt) {
      document.querySelectorAll('#emotion-wheel path').forEach(p => p.setAttribute("stroke-width", "2"));
      evt.target.setAttribute("stroke-width", "6");
      const emotion = evt.target.getAttribute("data-emotion");
      document.getElementById('selected-emotion').textContent = "Selected: " + emotion;
      document.getElementById('selected-emotion').setAttribute("data-selected", emotion);
      selectedEmotion = emotion;
      document.getElementById('saveEmotion').disabled = false;
    }

    // --- Mood Faces and Physical Hearts ---
    function setupSelection(containerId, itemClass, multiSelect=false) {
      const items = document.querySelectorAll(`#${containerId} .${itemClass}`);
      items.forEach((item, idx) => {
        item.onclick = () => {
          if (multiSelect) {
            items.forEach((h, i) => h.classList.toggle('selected', i<=idx));
          } else {
            items.forEach(f => f.classList.remove('selected'));
            item.classList.add('selected');
          }
        };
        item.onkeydown = e => {
          if (e.key === " " || e.key === "Enter") item.click();
        };
      });
    }

    // --- Save Emotion Entry ---
    document.getElementById('saveEmotion').onclick = function() {
      if (!selectedEmotion) return;
      const today = new Date().toISOString().split('T')[0];
      const entry = { date: today, emotion: selectedEmotion };
      let emotions = JSON.parse(localStorage.getItem('emotions')) || [];
      emotions.push(entry);
      localStorage.setItem('emotions', JSON.stringify(emotions));
      renderEntries();
      renderBarChart();
      document.getElementById('saveEmotion').disabled = true;
      selectedEmotion = null;
      document.getElementById('selected-emotion').textContent = '';
      drawEmotionWheel();
    };

    // --- Color by Emotion ---
    function getEmotionColor(emotion) {
      const emotions = loadEmotions().concat(svgEmotions);
      const found = emotions.find(e => e.name === emotion);
      return found ? found.color : '#888';
    }

    // --- Statistics and Log Entry ---
    function getMoodSymbol(idx) {
      return ["😢","🙁","😐","🙂","😃"][idx];
    }
    function getPhysicalLabel(idx) {
      return ["Poor","Fair","Average","Good","Excellent"][idx];
    }
    document.getElementById('track-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const errorEl = document.getElementById('formError');
      errorEl.textContent = '';
      let bp = document.getElementById('bp').value.trim();
      let weight = document.getElementById('weight').value.trim();
      let valid = true;
      if (bp && !/^\d{2,3}\/\d{2,3}$/.test(bp)) {
        errorEl.textContent = 'Blood pressure must be in the format 120/80.';
        valid = false;
      }
      if (weight && (isNaN(weight) || Number(weight)<10 || Number(weight)>300)) {
        errorEl.textContent = 'Weight must be between 10 and 300 kg.';
        valid = false;
      }
      if (!valid) return;
      // Update stats
      let moodIdx = Array.from(document.querySelectorAll('.face')).findIndex(f => f.classList.contains('selected'));
      let physicalIdx = Array.from(document.querySelectorAll('.heart')).filter(h => h.classList.contains('selected')).length - 1;
      if(moodIdx>=0) document.getElementById('stat-mood').textContent = getMoodSymbol(moodIdx);
      if(physicalIdx>=0) document.getElementById('stat-physical').textContent = getPhysicalLabel(physicalIdx);
      document.getElementById('stat-bp').textContent = bp || "—";
      document.getElementById('stat-weight').textContent = weight ? (weight + " kg") : '—';
      // Reset form
      document.getElementById('log-entry').textContent = "Logged!";
      setTimeout(()=>document.getElementById('log-entry').textContent="Log Entry",1000);
      document.getElementById('thoughts').value = "";
      this.reset();
    });

    // --- Chart Data ---
    function getEmotionData() {
      const emotions = JSON.parse(localStorage.getItem('emotions')) || [];
      const emotionCounts = {};
      emotions.forEach(entry => {
        if (!emotionCounts[entry.date]) emotionCounts[entry.date] = {};
        if (!emotionCounts[entry.date][entry.emotion]) emotionCounts[entry.date][entry.emotion] = 0;
        emotionCounts[entry.date][entry.emotion]++;
      });
      const dates = Object.keys(emotionCounts).sort();
      const allEmotions = loadEmotions().concat(svgEmotions).map(e => e.name);
      const datasets = allEmotions.map(emotion => ({
        label: emotion,
        backgroundColor: getEmotionColor(emotion),
        data: dates.map(date => emotionCounts[date][emotion] || 0)
      }));
      return { dates, datasets };
    }
    let emotionChart = null;
    function renderBarChart() {
      const ctx = document.getElementById('emotionBarChart').getContext('2d');
      const { dates, datasets } = getEmotionData();
      if (emotionChart) emotionChart.destroy();
      emotionChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: dates, datasets: datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Emotions Over Time' }
          },
          scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
        }
      });
    }

    // --- Render Entries List ---
    function renderEntries() {
      const emotions = JSON.parse(localStorage.getItem('emotions')) || [];
      const ul = document.getElementById('emotionList');
      ul.innerHTML = emotions.slice().reverse().map(e => 
        `<li><strong>${e.date}:</strong> <span style="color:${getEmotionColor(e.emotion)}">${sanitize(e.emotion)}</span></li>`
      ).join('');
    }

    // --- Export/Import Data ---
    function exportData() {
      const data = {
        emotions: localStorage.getItem('emotions') || "[]",
        emotionsList: localStorage.getItem('emotionsList') || "[]",
        activityTags: localStorage.getItem('activityTags') || "[]"
      };
      const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "emotional-wellness-data.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    function importDataFile(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.emotions) localStorage.setItem('emotions', data.emotions);
          if (data.emotionsList) localStorage.setItem('emotionsList', data.emotionsList);
          if (data.activityTags) localStorage.setItem('activityTags', data.activityTags);
          renderTags(); drawEmotionWheel(); renderEntries(); renderBarChart();
          alert("Data imported!");
        } catch {
          alert("Invalid import file.");
        }
      };
      reader.readAsText(file);
    }

    // --- Initial Load ---
    window.onload = function() {
      renderTags();
      drawEmotionWheel();
      renderEntries();
      renderBarChart();
      setupSelection('mood-faces', 'face');
      setupSelection('physical-hearts', 'heart', true);
    };
  </script>
</body>
</html>
