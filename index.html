<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Emotional Wellness Tracker</title>
  <meta name="description" content="Track your emotional wellness daily with interactive tools.">
  <meta name="author" content="Your Name">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self';">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
  <header>
    <h1>Emotional Wellness Tracker</h1>
    <div class="theme-controls">
      <button class="dark-toggle btn-secondary" aria-pressed="false" aria-label="Toggle dark mode" id="darkToggle">ðŸŒ™</button>
      <label for="themeSelect" class="visually-hidden">Choose Theme</label>
      <select id="themeSelect" aria-label="Choose Theme">
        <option value="">Default</option>
        <option value="theme-blue">Blue</option>
        <option value="theme-green">Green</option>
        <option value="theme-orange">Orange</option>
      </select>
    </div>
  </header>
  <main class="container" role="main">
    <!-- 1. Whatâ€™s going on now? -->
    <section class="section" aria-labelledby="activity-title">
      <h2 id="activity-title">1. What's going on now?</h2>
      <div class="tags" id="activity-tags" role="listbox" aria-label="Activity tags"></div>
      <form class="add-tag" onsubmit="return false;">
        <input type="text" id="newTagName" maxlength="20" placeholder="Add tag (e.g. Study)" aria-label="Add activity tag">
        <button type="button" onclick="addActivityTag()">Add Tag</button>
      </form>
    </section>

    <!-- 2. Howâ€™s your mood? -->
    <section class="section" aria-labelledby="mood-title">
      <h2 id="mood-title">2. How's your mood?</h2>
      <div id="emotion-wheel-container">
        <svg id="emotion-wheel" width="320" height="320" viewBox="0 0 320 320" aria-label="Emotion Wheel" tabindex="0" role="img"></svg>
        <div id="selected-emotion" aria-live="polite"></div>
        <em class="instruction">Tap a segment to select your primary emotion</em>
      </div>
      <div class="faces" id="mood-faces" aria-label="Mood faces">
        <span class="face" tabindex="0" title="Very sad" role="button" aria-label="Very sad">&#128577;</span>
        <span class="face" tabindex="0" title="Sad" role="button" aria-label="Sad">&#128542;</span>
        <span class="face" tabindex="0" title="Neutral" role="button" aria-label="Neutral">&#128528;</span>
        <span class="face" tabindex="0" title="Happy" role="button" aria-label="Happy">&#128522;</span>
        <span class="face" tabindex="0" title="Very happy" role="button" aria-label="Very happy">&#128515;</span>
      </div>
      <form class="add-emotion" onsubmit="return false;">
        <input type="text" id="newEmotionName" maxlength="20" placeholder="New emotion (e.g. Grateful)" aria-label="New emotion">
        <input type="color" id="newEmotionColor" value="#888888" aria-label="Pick color">
        <button type="button" onclick="addEmotion()">Add Emotion</button>
      </form>
      <button id="saveEmotion" disabled>Save Emotion</button>
    </section>
    <!-- Mood trend analytics -->
    <section class="section" aria-labelledby="trend-title">
      <h2 id="trend-title">Mood Trend Analytics</h2>
      <canvas id="emotionTrendChart" loading="lazy" aria-label="Emotion Trends Over Time"></canvas>
    </section>

    <!-- 3. How are you physically? -->
    <section class="section" aria-labelledby="phys-title">
      <h2 id="phys-title">3. How are you physically?</h2>
      <div class="hearts" id="physical-hearts" aria-label="Physical condition hearts">
        <span class="heart" tabindex="0" title="Poor" role="button" aria-label="Poor">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Fair" role="button" aria-label="Fair">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Average" role="button" aria-label="Average">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Good" role="button" aria-label="Good">&#10084;&#65039;</span>
        <span class="heart" tabindex="0" title="Excellent" role="button" aria-label="Excellent">&#10084;&#65039;</span>
      </div>
    </section>

    <!-- 4. Track blood pressure, weight, and thoughts -->
    <section class="section track-options" aria-labelledby="track-title">
      <h2 id="track-title" class="visually-hidden">Track Options</h2>
      <form id="track-form" autocomplete="off" novalidate>
        <div class="input-group">
          <label for="bp">Blood Pressure:</label>
          <input id="bp" type="text" pattern="^\\d{2,3}/\\d{2,3}$" placeholder="e.g., 120/80" aria-describedby="bpHelp">
          <small id="bpHelp" class="help-block">Format: systolic/diastolic (e.g., 120/80)</small>
        </div>
        <div class="input-group">
          <label for="weight">Weight (kg):</label>
          <input id="weight" type="number" step="0.1" min="10" max="300" placeholder="e.g., 70.5">
        </div>
        <div class="input-group">
          <label for="thoughts">Thoughts or Reflections:</label>
          <textarea id="thoughts" placeholder="Add any thoughts or notes..." aria-label="Thoughts or reflections"></textarea>
        </div>
        <button class="btn" id="log-entry" type="submit">Log Entry</button>
        <div id="formError" class="error-msg" role="alert" aria-live="assertive"></div>
      </form>
    </section>

    <!-- 5. User statistics display -->
    <section class="stats" id="user-stats" aria-labelledby="stats-title">
      <h2 id="stats-title">Your Statistics</h2>
      <div class="stat-item">Average Mood: <span id="stat-mood" aria-live="polite">ðŸ™‚</span></div>
      <div class="stat-item">Physical Condition: <span id="stat-physical" aria-live="polite">Good</span></div>
      <div class="stat-item">Blood Pressure: <span id="stat-bp" aria-live="polite">120/80</span></div>
      <div class="stat-item">Weight: <span id="stat-weight" aria-live="polite">70.5 kg</span></div>
    </section>

    <!-- Entries -->
    <section aria-labelledby="entries-title">
      <h2 id="entries-title">My Entries</h2>
      <ul id="emotionList" aria-live="polite"></ul>
    </section>

    <!-- Export/Import Data -->
    <section class="export-import" aria-label="Export and Import Data">
      <button class="btn-secondary" onclick="exportData()">Export Data</button>
      <input type="file" id="importDataFile" accept=".json" style="display:none" onchange="importDataFile(this)">
      <button class="btn-secondary" onclick="document.getElementById('importDataFile').click();">Import Data</button>
      <div id="importPreviewContainer"></div>
    </section>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // --- Theme Switcher ---
  document.addEventListener('DOMContentLoaded', function() {
    // Theme initialization
    const themeSelect = document.getElementById('themeSelect');
    const savedTheme = localStorage.getItem('ewt_theme');
    if (savedTheme) {
      themeSelect.value = savedTheme;
      document.body.classList.add(savedTheme);
    }
    themeSelect.addEventListener('change', function() {
      document.body.className = document.body.className.replace(/theme-\w+/g, '').trim();
      if (this.value) document.body.classList.add(this.value);
      localStorage.setItem('ewt_theme', this.value);
    });

    // Dark mode toggle
    const darkToggle = document.getElementById('darkToggle');
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      darkToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
      localStorage.setItem('ewt_dark', isDark ? '1' : '');
    });
    if (localStorage.getItem('ewt_dark')) document.body.classList.add('dark-mode');
  });

  // --- Improved Import with Preview ---
  function importDataFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        // Preview data
        const previewContainer = document.getElementById('importPreviewContainer');
        previewContainer.innerHTML = `
          <div class="import-preview">
            <h3>Preview Import Data</h3>
            <pre style="max-height:200px;overflow:auto;background:#eee">${JSON.stringify(data, null, 2)}</pre>
            <button id="confirmImportBtn">Confirm Import</button>
            <button id="cancelImportBtn">Cancel</button>
          </div>
        `;
        document.getElementById('confirmImportBtn').onclick = () => {
          if (data.emotions) localStorage.setItem('emotions', data.emotions);
          if (data.emotionsList) localStorage.setItem('emotionsList', data.emotionsList);
          if (data.activityTags) localStorage.setItem('activityTags', data.activityTags);
          renderTags(); drawEmotionWheel(); renderEntries(); renderTrendLineChart();
          alert("Data imported!");
          previewContainer.innerHTML = '';
        };
        document.getElementById('cancelImportBtn').onclick = () => previewContainer.innerHTML = '';
      } catch {
        alert("Invalid import file.");
      }
    };
    reader.readAsText(file);
  }

  // --- Export Data ---
  function exportData() {
    const data = {
      emotions: localStorage.getItem('emotions') || "[]",
      emotionsList: localStorage.getItem('emotionsList') || "[]",
      activityTags: localStorage.getItem('activityTags') || "[]"
    };
    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "emotional-wellness-data.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // --- Mood Trend Line Chart (Emotion Analytics) ---
  function renderTrendLineChart() {
    const ctx = document.getElementById('emotionTrendChart').getContext('2d');
    const emotions = JSON.parse(localStorage.getItem('emotions')) || [];
    // For demo, each entry is {date: 'YYYY-MM-DD', emotion: 'Happy'...}
    const moodOrder = ["Very sad", "Sad", "Neutral", "Happy", "Very happy"];
    const dateMap = {};
    emotions.forEach(entry => {
      if (!dateMap[entry.date]) dateMap[entry.date] = [];
      dateMap[entry.date].push(entry.emotion);
    });
    const labels = Object.keys(dateMap).sort();
    const data = labels.map(date => {
      const moods = dateMap[date];
      if (!moods.length) return null;
      const avg = moods.map(m => moodOrder.indexOf(m)).reduce((a, b) => a + b, 0) / moods.length;
      return avg;
    });
    if (window.emotionTrendChartObj) window.emotionTrendChartObj.destroy();
    window.emotionTrendChartObj = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Average Mood',
          data,
          borderColor: '#3e95cd',
          fill: false,
          tension: 0.2
        }]
      },
      options: {
        plugins: {
          title: { display: true, text: 'Mood Trends Over Time' }
        },
        scales: {
          y: {
            min: 0,
            max: moodOrder.length - 1,
            ticks: {
              callback: value => moodOrder[value] || ''
            }
          }
        }
      }
    });
  }

  // --- Call on page load and after any emotion is logged ---
  window.addEventListener('DOMContentLoaded', function() {
    // ... other initializations ...
    renderTrendLineChart();
    // Call your other initialization functions here, e.g.:
    // renderTags(); drawEmotionWheel(); renderEntries();
  });

  </script>
</body>
</html>
